# –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
  - install-kpbr.sh - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –ø–æ –¥–æ–º–µ–Ω–Ω—ã–º –∏–º–µ–Ω–∞–º.
    - —Ç—è–Ω–µ—Ç nftset.conf —Å–æ —Å–ø–∏—Å–∫–∞–º–∏ –¥–æ–º–µ–Ω–æ–≤ –ø–æ wan –∏ vpn
    - —Ç—è–Ω–µ—Ç vpn-cidrs.lst —Å–æ —Å–ø–∏—Å–æ–∫ cidr –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø—É—Å–∫–∞—Ç—å —á–µ—Ä–µ–∑ vpn (tg, claude etc)
    - –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è VPN, –Ω–∏–∂–µ –æ–ø–∏—Å–∞–Ω–æ –∫–∞–∫ –ø–æ—Å—Ç–∞–≤–∏—Ç—å amneziawg –¥–ª—è –Ω–µ–≥–æ. 
  - update-kpbr.sh - –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–ø–∏—Å–∫–∏ nftset.conf –∏ vpn-cidrs.lst –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∏–∑ —Ä–µ–ø—ã.
  - create-nftsets.sh - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±–æ—Ä–∞ nftset.conf –∏–∑ —Ñ–∞–π–ª–æ–≤ —Å–æ —Å–ø–∏—Å–∫–∞–º–∏ –¥–æ–º–µ–Ω–æ–≤ (–∏–∑ sources/)

# install-kpbr.sh - kpbe Installation Script

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Dnsmasq-full –¥–ª—è OpenWrt 24.10.2 –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –ø–æ –¥–æ–º–µ–Ω–∞–º. 
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–≤–∞ —Å–ø–∏—Å–∫–∞. 
  - WAN - –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é, 
  - VPN - –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å VPN (—Ö–∞—Ä–¥–∫–æ–¥ 'amneziawg' –∏–º—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞).
–°–ø–∏—Å–æ–∫ IP –∏ –¥–æ–º–µ–Ω–Ω—ã—Ö –∏–º–µ–Ω –±–µ—Ä–µ—Ç—Å—è –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–Ω—ã—Ö nftset.conf –∏ vpn-cidrs.lst.

## HOWTO –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–æ—É—Ç–µ—Ä
1. –°—Ç–∞–≤–∏–º –ø—Ä–æ—à–∏–≤–∫—É openwrt. –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–æ—É—Ç–µ—Ä–∞.
3. –°—Ç–∞–≤–∏–º —Å–∫—Ä–∏–ø—Ç–æ–º AmneziaWG 
	`sh <(wget -O - https://raw.githubusercontent.com/Slava-Shchipunov/awg-openwrt/refs/heads/master/amneziawg-install.sh)`
4. –í—Ä—É—á–Ω—É—é –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏ –≤–∫–ª—é—á–∞–µ–º WiFi, —Å–æ–∑–¥–∞–µ–º awg –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –∏–º–µ–Ω–µ–º `amneziawg` –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ awg. 
5. –ù–∞–∫–∞—Ç–∏—Ç—å install-kpbr.sh
	`sh <(wget -O - https://raw.githubusercontent.com/kozian/kpbr/refs/heads/main/install-kpbr.sh)`

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç

1. ‚úÖ –£–¥–∞–ª—è–µ—Ç dnsmasq –∏ —Å—Ç–∞–≤–∏—Ç dnsmasq-full
2. ‚úÖ –°–æ–∑–¥–∞–µ—Ç nftset –¥–ª—è VPN –∏ WAN —Å–ø–∏—Å–∫–æ–≤ –¥–æ–º–µ–Ω–æ–≤
3. ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç dnsmasq –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–º–µ–Ω–æ–≤ –≤ nftset
4. ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –º–∞—Ä–∫–∏—Ä–æ–≤–∫—É –ø–∞–∫–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ nftables
5. ‚úÖ –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ (vpnroute, wanroute)
6. ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ —Å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–æ–º
7. ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç –∏–∑–≤–µ—Å–Ω—ã–µ –≥–µ–æ–±–ª–æ–∫ –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ CIDR –≤ nftset

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- OpenWrt 24.10.2
- –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π VPN –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `amneziawg`
- –î–æ—Å—Ç—É–ø –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é —Å —Ñ–∞–π–ª–∞–º–∏ `nftset.conf` –∏ `vpn-cirds.lst` (–∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º)

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
wget -qO- https://raw.githubusercontent.com/kozian/kpbr/refs/heads/main/install-kpbr.sh | sh
```

–∏–ª–∏ —Å–∫–∞—á–∞—Ç—å –≤—Å–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å

```bash
wget https://raw.githubusercontent.com/kozian/kpbr/refs/heads/main/install-kpbr.sh
wget https://raw.githubusercontent.com/kozian/kpbr/refs/heads/main/nftset.conf
wget https://raw.githubusercontent.com/kozian/kpbr/refs/heads/main/vpn-cidrs.lst
chmod +x install-kpbr.sh
./install-kpbr.sh
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ nftsets
nft list set inet fw4 vpn_domain_set
nft list set inet fw4 wan_domain_set

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
ip rule show

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
ip route show table vpnroute
ip route show table wanroute

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ dnsmasq
dnsmasq --test
```

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É PBR –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ echo-—Å–µ—Ä–≤–∏—Å—ã. 
–í —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ü–µ–ª—è—Ö ifconfig.me –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫ VPN, –∞ ifconfig.io - WAN
https://ifconfig.me
https://ifconfig.io

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏

```
/etc/
‚îú‚îÄ‚îÄ nftables.d/
‚îÇ   ‚îú‚îÄ‚îÄ sets.nft          # NFT sets –¥–ª—è –¥–æ–º–µ–Ω–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ rules.nft         # –ü—Ä–∞–≤–∏–ª–∞ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ vpn-cirds.lst     # –°–ø–∏—Å–æ–∫ CIDR –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ vpn
‚îú‚îÄ‚îÄ dnsmasq.d/
‚îÇ   ‚îî‚îÄ‚îÄ nftset.conf       # –°–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ –¥–ª—è nftset
‚îú‚îÄ‚îÄ iproute2/
‚îÇ   ‚îî‚îÄ‚îÄ rt_tables         # –¢–∞–±–ª–∏—Ü—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ hotplug.d/
‚îÇ   ‚îî‚îÄ‚îÄ iface/
‚îÇ       ‚îî‚îÄ‚îÄ 25-firewall-user  # –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∞–≤–∏–ª
‚îî‚îÄ‚îÄ firewall.user         # –°–∫—Ä–∏–ø—Ç firewall –≤–∫–ª—é—á–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç CIDR
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞:

```bash
# –û—Ç–∫—É–¥–∞ —Å–∫–∞—á–∏–≤–∞—Ç—å nftset –∏ CIDR —Ñ–∞–π–ª—ã
REPO_URL="https://raw.githubusercontent.com/kozian/kpbr/refs/heads/main/"
NFTSET_FILE="nftset.lst"
CIDR_FILE="vpn-cidrs.lst"

# –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è VPN
VPN_INTERFACE="amneziawg"
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

–°–∫—Ä–∏–ø—Ç `update-kpbr.sh` –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

- üì• –°–∫–∞—á–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–æ–≤ `nftset.conf` –∏ `vpn-cidrs.lst` –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
- üîç –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç - –≤—ã—Ö–æ–¥–∏—Ç)
- üíæ –°–æ–∑–¥–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Ç–µ–∫—É—â–∏—Ö —Ñ–∞–π–ª–æ–≤ —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π
- üîÑ –û–±–Ω–æ–≤–ª—è–µ—Ç —Ñ–∞–π–ª—ã
- ‚úÖ –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (—Ç–µ—Å—Ç dnsmasq + –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ firewall.user)
- ‚ö†Ô∏è –í —Å–ª—É—á–∞–µ –æ—à–∏–±–æ–∫ - –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
- üìù –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ `/var/log/kpbr-update.log`

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

```bash
wget https://raw.githubusercontent.com/kozian/kpbr/refs/heads/main/update-kpbr.sh
chmod +x update-kpbr.sh
./update-kpbr.sh
```

–ò–ª–∏ –ø—Ä—è–º–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:

```bash
sh <(wget -O - https://raw.githubusercontent.com/kozian/kpbr/refs/heads/main/update-kpbr.sh)
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ cron

–î–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–∞—á—É –≤ cron:

```bash
# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å crontab
crontab -e
```

–î–æ–±–∞–≤—å—Ç–µ –æ–¥–Ω—É –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö —Å—Ç—Ä–æ–∫:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 –Ω–æ—á–∏
0 3 * * * /root/update-kpbr.sh >> /var/log/kpbr-update.log 2>&1

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
0 */6 * * * /root/update-kpbr.sh >> /var/log/kpbr-update.log 2>&1

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 2:00
0 2 * * 0 /root/update-kpbr.sh >> /var/log/kpbr-update.log 2>&1
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—É—Ç—å –∫ —Å–∫—Ä–∏–ø—Ç—É –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π. –í –ø—Ä–∏–º–µ—Ä–∞—Ö –≤—ã—à–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `/root/update-kpbr.sh`.

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron —á–µ—Ä–µ–∑ UCI (OpenWrt)

–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è OpenWrt —á–µ—Ä–µ–∑ UCI:

```bash
# –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É cron
echo "0 3 * * * /root/update-kpbr.sh" >> /etc/crontabs/root

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å cron
/etc/init.d/cron restart
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
cat /var/log/kpbr-update.log
```

### –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º:

- `/etc/dnsmasq.d/nftset.conf_YYYYMMDD_HHMMSS.bak`
- `/etc/nftables.d/vpn-cidrs.lst_YYYYMMDD_HHMMSS.bak`

–•—Ä–∞–Ω—è—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞. –°—Ç–∞—Ä—ã–µ –∫–æ–ø–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è.

### –†—É—á–Ω–æ–π –æ—Ç–∫–∞—Ç –∫ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –≤—Ä—É—á–Ω—É—é:

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏
ls -la /etc/dnsmasq.d/*.bak
ls -la /etc/nftables.d/*.bak

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ (–∑–∞–º–µ–Ω–∏—Ç–µ TIMESTAMP –Ω–∞ –Ω—É–∂–Ω—É—é –¥–∞—Ç—É)
cp /etc/dnsmasq.d/nftset.conf_TIMESTAMP.bak /etc/dnsmasq.d/nftset.conf
cp /etc/nftables.d/vpn-cidrs.lst_TIMESTAMP.bak /etc/nftables.d/vpn-cidrs.lst

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
/etc/init.d/dnsmasq restart
/etc/firewall.user
```

## Troubleshooting

### –û—à–∏–±–∫–∞: "Could not detect WAN gateway or interface"

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω default route:
```bash
ip route
```

### –û—à–∏–±–∫–∞: "Failed to download nftset list"

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:
```bash
wget https://raw.githubusercontent.com/kozian/kpbr/refs/heads/main/nftset.conf
```

### –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ dnsmasq-full

–í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
```bash
df -h
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π:
```bash
cat /var/log/kpbr-update.log
```

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:
```bash
chmod +x /root/update-kpbr.sh
```

## –£–¥–∞–ª–µ–Ω–∏–µ

–î–ª—è –æ—Ç–∫–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π:

```bash
# –£–¥–∞–ª–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
rm -f /etc/nftables.d/sets.nft
rm -f /etc/nftables.d/rules.nft
rm -f /etc/dnsmasq.d/nftset.conf
rm -f /etc/firewall.user
rm -f /etc/hotplug.d/iface/25-firewall-user

# –£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ rt_tables
sed -i '/vpnroute/d' /etc/iproute2/rt_tables
sed -i '/wanroute/d' /etc/iproute2/rt_tables

# –£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
ip rule del fwmark 0x1 lookup vpnroute
ip rule del fwmark 0x2 lookup wanroute

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
/etc/init.d/firewall restart
/etc/init.d/dnsmasq restart
```

## –õ–∏—Ü–µ–Ω–∑–∏—è

–°–∫—Ä–∏–ø—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è "–∫–∞–∫ –µ—Å—Ç—å" –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ –≥–∞—Ä–∞–Ω—Ç–∏–π.
–°–¥–µ–ª–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é claude code.
