# Установка AmneziaWG
## Предусловия
1. На роутере установлена OpenWRT. См. инструкцию для роутера, например для [CUDY TR3000](./CUDY-TR3000.md). 
2. Файл конфигурации AmneziaWG. Конфиг должен быть в `AmneziaWG json` формате, не AmneziaVPN. (В [приложении 1](#приложение-1---пример-конфигурации) есть пример)

## Установка

### Установка пакетов
1. Подключаемся к роутеру по ssh `ssh root@192.168.1.1`. Пароль - тот же какой был установлен при настройке роутера.
2. Запускаем скрипт установки, который установить соответствующие роутеру 
```bash
   sh <(wget -O - https://raw.githubusercontent.com/Slava-Shchipunov/awg-openwrt/refs/heads/master/amneziawg-install.sh)
```

### Настройка интерфейса
3. Переходим в веб-интерфейс роутера. Network (Сеть) > [Interfaces (Интерфейсы)](http://192.168.1.1/cgi-bin/luci/admin/network/network)
4. Нажимаем `Add new interface...` (`Добавить новый интерфейс...`)
   - `Name` (`Имя`) указываем `amneziawg`
   - `Protocol` (`Протокол`) выбираем `AmneziaWG VPN`
   - Нажимаем `Create Interface` (`Создать интерфейс`)
5. Самый нижний пункт - кнопка `Load configuration…` (`Загрузка конфигурации…`) - нажимаем ее. 
6. Копируем из файла конфигурации AmneziaWG текст в окно. Нажимаем `Import settings` (`Импорт настроек`). 
7. Переходим во вкладку `Firewall Settings` (`Настройки межсетевого экрана`).
8. В выпдающем меню `Create / Assign firewall-zone` (`Создать / назначить зону межсетевого экрана`) выбираем нижний пункт `-- custom --` (`-- пользовательский --`), пишем там `awg` и нажимаем ввод.
9. Нажимаем `Save` (`Схоранить`), потом `Save & Apply` (`Применить`). 
10. Переходим в меню `Network` (`Сеть`) > `Firewall` (`Межсетевой экран`).
11. В нижней секции `Zones` (`Зоны`) в строке с созданной нами `awg` зоной выбираем `Edit` (`Изменить`)
   - Устанавливаем галочку `Masquerading` (`Маскарадинг`)
   - В выпадающем меню `Allow forward from source zones:` (`Разрешить перенаправление из 'зон источников':`) выбираем `lan`
   - нажимаем `Save` (`Сохранить`), потом `Save & Apply` (`Применить`)


### Маршрутизация на VPN по-умолчанию
**! Важно**: установка kpbr определяет WAN интерфейс по default маршруту. Если планируете устанавливать его, отложите включение маршрутизации пока его не установите.

По-умолчанию трафик не направляется через VPN, если явно не прописаны маршруты. 
Чтобы установить маршрутизацию трафкиа по-умочанию через VPN, нужно:
- Для интерфейса amneziawg выбрать `Edit` (`Изменить`)
- Перейти в последнюю вкладку `Peers` (`Равноправные узлы`)
- Напротив узла нажать `Edit` (`Изменить`)
- Установить галку `Route Allowed IPs` (`Маршрутизировать разрешённые IP-адреса`)
- Нажимаем `Save` (`Сохранить`) > `Save` (`Сохранить`) > `Save & Apply` (`Применить`)

Чтобы убрать маршрутизацию трафика - снять галку `Route Allowed IPs` (`Маршрутизировать разрешённые IP-адреса`)

# Приложение 1 - пример конфигурации.
Конфигурация для AmneziaWG выглядит вот таким образом. Это НЕРАБОТАЮЩИЙ пример, для визуального понимания как это выглядит и что нужно вставить в блок импорта конфигурации. 

```
[Interface]
Address = 10.0.0.1/32
DNS = 1.1.1.1, 1.0.0.1
PrivateKey = I3EO0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiI3E=
Jc = 5
Jmin = 11
Jmax = 31
S1 = 83
S2 = 142
H1 = 1312319836
H2 = 244803842
H3 = 63849485
H4 = 2023984725

[Peer]
PublicKey = 8YI0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiI9+FC=
PresharedKey = YakaXRodWIuY29tIiwiYXVkIjoicmVsZWFzZ+4J=
AllowedIPs = 0.0.0.0/0, ::/0
Endpoint = 192.225.224.36:34515
PersistentKeepalive = 25
```