# Установка AmneziaWG
## Предусловия
1. На роутере установлена OpenWRT. См. инструкцию для роутера. 
2. Есть AmneziaWG сервер и конфиг для подключения к нему. Конфиг для импорта должен быть в `AmneziaWG json` формате, не AmneziaVPN. (В `приложении 1` есть пример)

## Установка

### Установка пакетов
1. Подключаемся к роутеру по ssh `ssh root@192.168.1.1`. Пароль - тот же какой был установлен при настройке роутера.
2. Запускаем скрипт установки, который установить соответствующие роутеру 
   `sh <(wget -O - https://raw.githubusercontent.com/Slava-Shchipunov/awg-openwrt/refs/heads/master/amneziawg-install.sh)`

### Настройка интерфейса
3. Переходим в веб-интерфейс роутера. Network (Сеть) > [Interfaces (Интерфейсы)](http://192.168.1.1/cgi-bin/luci/admin/network/network)
4. Нажимаем `Add new interface...` (`Добавить новый интерфейс...`)
5. Name (Имя) указываем `amneziawg`, `Protocol` (`Протокол`) указываем `AmneziaWG VPN`. Нажимаем `Create Interface` (`Создать интерфейс`)
6. Самый нижний пункт - кнопка `Load configuration…` - нажимаем ее. 
7. Копируем из файла конфигурации AmneziaWG текст в окно. Нажимаем `Import settings` (`2`). 
8. Переходим во вкладку `Firewall Settings` (`Настройки межсетевого экрана`).
9. В выпдающем меню `Create / Assign firewall-zone` (`Создать / назначить зону межсетевого экрана`) выбираем нижний пункт `-- custom --` (`-- пользовательский --`), пишем там `awg` и нажимаем ввод.
10. Нажимаем `Save` (`Схоранить`), потом `Save & Apply` (`Применить`). 
11. Переходим в меню `Network` (`Сеть`) > `Firewall` (`Межсетевой экран`).
12. В нижней секции `Zones` (`Зоны`) в строке с созданной нами `awg` зоной выбираем `Edit` (`Изменить`)
   - Устанавливаем галочку `Masquerading` (`Маскарадинг`)
   - В выпадающем меню `Allow forward from source zones:` (`Разрешить перенаправление из 'зон источников':`) выбираем `lan`
   - нажимаем `Save` (`Сохранить`), потом `Save & Apply` (`Применить`)


**! Важно**: установка kpbr определяет WAN интерфейс по default маршруту. Если планируете устанавливать его, не включайте эту маршрутизацию до установки. 

По-умолчанию трафик не направляется через VPN, если явно не прописаны маршруты. 
Чтобы установить маршрутизацию трафкиа по-умочанию через VPN, нужно:
- Для интерфейса amneziawg выбрать `Edit` (`Изменить`)
- Перейти в последнюю вкладку `Peers` (`Равноправные узлы`)
- Напротив узла нажать `Edit` (`Изменить`)
- Установить галку `Route Allowed IPs` (`Маршрутизировать разрешённые IP-адреса`)
- Нажимаем `Save` (`Сохранить`) > `Save` (`Сохранить`) > `Save & Apply` (`Применить`)

Чтобы убрать маршрутизацию трафика - снять галку `Route Allowed IPs` (`Маршрутизировать разрешённые IP-адреса`)

# Приложение 1 - пример конфигурации.
Конфигурация для AmneziaWG выглядит вот таким образом. Это НЕРАБОТАЮЩИЙ пример, для визуального понимания как это выглядит и что нужно вставить в блок импорта конфигурации. 

```
[Interface]
Address = 10.0.0.1/32
DNS = 1.1.1.1, 1.0.0.1
PrivateKey = I3EO0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiI3E=
Jc = 5
Jmin = 11
Jmax = 31
S1 = 83
S2 = 142
H1 = 1312319836
H2 = 244803842
H3 = 63849485
H4 = 2023984725

[Peer]
PublicKey = 8YI0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiI9+FC=
PresharedKey = YakaXRodWIuY29tIiwiYXVkIjoicmVsZWFzZ+4J=
AllowedIPs = 0.0.0.0/0, ::/0
Endpoint = 192.225.224.36:34515
PersistentKeepalive = 25
```